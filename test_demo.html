<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity AI Gateway - Demo & Tracker</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .box {
            background: var(--card);
            border: 1px solid #e2e8f0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .box h2 {
            margin-top: 0;
            font-size: 1.2rem;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s;
            margin-top: 10px;
        }

        button.secondary {
            background: #64748b;
        }

        button.secondary:hover {
            background: #475569;
        }

        /* Image Preview */
        .img-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            border: 2px dashed #cbd5e1;
        }

        .generated-img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Output Box */
        #output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            min-height: 100px;
            overflow-x: auto;
        }

        .loading {
            color: #94a3b8;
            font-style: italic;
        }

        /* Tracker Styles */
        .tracker-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-val {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .progress-container {
            background: #e2e8f0;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-bar.warning {
            background: linear-gradient(90deg, #facc15, #eab308);
        }

        .progress-bar.danger {
            background: linear-gradient(90deg, #f87171, #ef4444);
        }

        .reset-btn {
            background: transparent;
            color: #64748b;
            border: 1px solid #cbd5e1;
            padding: 5px 10px;
            width: auto;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .reset-btn:hover {
            background: #f1f5f9;
            color: #ef4444;
            border-color: #ef4444;
        }
    </style>
</head>

<body>
    <h1>üöÄ Antigravity Gateway Demo</h1>

    <!-- Quota Tracker Section -->
    <div class="box">
        <h2>üìä Quota Tracker (D·ª± t√≠nh)</h2>
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div class="tracker-grid">
            <div class="stat-card">
                <label>ƒê√£ d√πng h√¥m nay</label>
                <div class="stat-val" id="usedCount">0</div>
            </div>
            <div class="stat-card">
                <label>Gi·ªõi h·∫°n (T·ª± ƒë·∫∑t)</label>
                <input type="number" id="dailyLimit" value="100"
                    style="margin-bottom:0; text-align:center; font-weight:bold; color:var(--text);"
                    onchange="updateTrackerUI()">
            </div>
        </div>
        <p style="font-size: 0.8rem; color: #64748b; text-align: center;">*B·ªô ƒë·∫øm client-side.</p>
        <div style="text-align: center;">
            <button class="reset-btn" onclick="resetQuota()">üîÑ Reset ƒë·∫øm v·ªÅ 0</button>
        </div>
    </div>

    <!-- Calculator / Connection Section -->
    <div class="box">
        <h2>üîå Giao Di·ªán Test ƒêa NƒÉng</h2>
        <div class="tracker-grid">
            <div>
                <label>IP M√°y Ch·ªß:</label>
                <input type="text" id="host" value="http://26.197.92.157:8317">
            </div>
            <div>
                <label>API Key:</label>
                <input type="password" id="apiKey" value="sk-antigravity">
            </div>
        </div>

        <label>Ch·ªçn Model:</label>
        <select id="model">
            <optgroup label="üåü Gemini (Google)">
                <option value="gemini-3-flash">Gemini 3 Flash (M·ªõi & Nhanh)</option>
                <option value="gemini-3-pro">Gemini 3 Pro (Si√™u M·∫°nh)</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
            </optgroup>
            <optgroup label="üé® T·∫°o ·∫¢nh (Google Imagen 3)">
                <option value="imagen-3">Imagen 3 (S·∫Øc n√©t)</option>
                <option value="nanobanana">Nano Banana (Native)</option>
                <option value="nanobanana-pro">Nano Banana Pro (Logic Cao)</option>
            </optgroup>
            <optgroup label="üß† Claude & Kh√°c">
                <option value="claude-4.5-sonnet">Claude 4.5 Sonnet</option>
            </optgroup>
            <optgroup label="ü§ñ Kh√°c">
                <option value="gpt-oss">GPT OSS 120B</option>
            </optgroup>
        </select>

        <!-- Search Toggle -->
        <div
            style="margin-bottom: 15px; background: #e0f2fe; padding: 10px; border-radius: 6px; border: 1px solid #7dd3fc;">
            <label style="display:flex; align-items:center; cursor:pointer; margin:0; color:#0369a1;">
                <input type="checkbox" id="enableSearch" style="width:20px; height:20px; margin:0 10px 0 0;">
                üåç K√≠ch ho·∫°t Google Search (Grounding)
            </label>
        </div>

        <!-- Image Input (Vision) -->
        <div
            style="margin-bottom: 15px; border: 2px dashed #cbd5e1; padding: 15px; text-align: center; border-radius: 6px;">
            <label style="cursor: pointer; color: var(--primary);">
                üì∑ <b>G·ª≠i ·∫¢nh (Vision)</b> - Ch·ªçn file ƒë·ªÉ g·ª≠i k√®m
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="previewImage()">
            </label>
            <img id="imgPreview" class="img-preview">
            <div id="imgName" style="font-size: 0.8rem; color: #64748b; margin-top: 5px;"></div>
        </div>

        <label>Prompt / N·ªôi dung:</label>
        <textarea id="prompt" rows="3"
            placeholder="Nh·∫≠p c√¢u h·ªèi ho·∫∑c m√¥ t·∫£ ·∫£nh mu·ªën t·∫°o...">V·∫Ω m·ªôt ch√∫ m√®o phi h√†nh gia ƒëang bay l∆∞·ª£n trong v≈© tr·ª•, phong c√°ch Cyberpunk.</textarea>

        <div class="tracker-grid">
            <button onclick="sendRequest()">ÔøΩ G·ª≠i Chat (Text/Vision)</button>
            <button class="secondary" onclick="generateImage()">üé® T·∫°o ·∫¢nh (Image Gen)</button>
        </div>
    </div>

    <!-- Output Section -->
    <div class="box">
        <h2>üìù K·∫øt qu·∫£</h2>
        <div id="output">ƒêang ch·ªù t√≠n hi·ªáu...</div>
    </div>

    <script>
        // Init Tracker
        const STORAGE_KEY = 'antigravity_quota';
        const todayStr = new Date().toISOString().split('T')[0];
        function getQuotaData() { const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); return data.date !== todayStr ? { date: todayStr, used: 0 } : data; }
        function saveQuotaData(used) { localStorage.setItem(STORAGE_KEY, JSON.stringify({ date: todayStr, used: used })); updateTrackerUI(); }
        function updateTrackerUI() {
            const data = getQuotaData(); const limit = parseInt(document.getElementById('dailyLimit').value) || 100;
            const percent = Math.min((data.used / limit) * 100, 100);
            document.getElementById('usedCount').innerText = `${data.used} / ${limit}`;
            const bar = document.getElementById('progressBar'); bar.style.width = `${percent}%`;
            bar.className = 'progress-bar' + (percent > 90 ? ' danger' : percent > 70 ? ' warning' : '');
        }
        function resetQuota() { if (confirm('Reset?')) saveQuotaData(0); }
        updateTrackerUI();

        // Image Logic
        let selectedImageBase64 = null;

        function previewImage() {
            const file = document.getElementById('imageInput').files[0];
            const preview = document.getElementById('imgPreview');
            const name = document.getElementById('imgName');

            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    selectedImageBase64 = reader.result;
                    preview.src = reader.result;
                    preview.style.display = 'block';
                    name.innerHTML = `
                        ƒê√£ ch·ªçn: <b>${file.name}</b><br>
                        <div style="background:#f0fdf4; border:1px solid #86efac; padding:5px; border-radius:4px; margin-top:5px; font-size:0.8rem; color:#166534">
                            <b>üí° Ph√¢n bi·ªát Model:</b><br>
                            - <b>Nano Native:</b> S·ª≠a tr·ª±c ti·∫øp tr√™n ·∫£nh n√†y (Edit).<br>
                            - <b>Nano Pro:</b> "Nh√¨n" ·∫£nh n√†y r·ªìi v·∫Ω l·∫°i ·∫£nh m·ªõi x·ªãn h∆°n (Re-imagine).
                        </div>`;
                }
                reader.readAsDataURL(file);
            } else {
                selectedImageBase64 = null;
                preview.style.display = 'none';
                name.innerText = "";
            }
        }

        async function sendRequest() {
            // Chat & Vision Logic
            executeApiCall('/v1/chat/completions', 'chat');
        }

        async function generateImage() {
            let promptVal = document.getElementById('prompt').value;
            let model = document.getElementById('model').value;

            // EXCEPTION: Nano Models (Native Gen) -> No Search, No Prefix
            if (model.includes('nanobanana')) {
                document.getElementById('enableSearch').checked = false;
                // Gi·ªØ nguy√™n prompt, kh√¥ng th√™m "T√¨m ki·∫øm..."
            } else {
                // Legacy Logic for Search-based models (Imagen 3 fallback)
                document.getElementById('enableSearch').checked = true;
                if (!promptVal.toLowerCase().includes("t√¨m ·∫£nh") && !promptVal.toLowerCase().includes("v·∫Ω")) {
                    promptVal = "T√¨m ki·∫øm v√† hi·ªÉn th·ªã h√¨nh ·∫£nh v·ªÅ: " + promptVal;
                } else {
                    promptVal = "H√£y t√¨m ki·∫øm v√† hi·ªÉn th·ªã k·∫øt qu·∫£ h√¨nh ·∫£nh cho: " + promptVal;
                }
                document.getElementById('prompt').value = promptVal;
            }

            // G·ªçi qua Chat Endpoint
            executeApiCall('/v1/chat/completions', 'image');
        }

        async function executeApiCall(endpoint, type) {
            const host = document.getElementById('host').value.replace(/\/$/, "");
            const apiKey = document.getElementById('apiKey').value;
            let model = document.getElementById('model').value; // D√πng let ƒë·ªÉ s·ª≠a ƒë·ªïi
            const prompt = document.getElementById('prompt').value;
            const outputFunc = document.getElementById('output');
            const useSearch = document.getElementById('enableSearch').checked;

            // Client-Side Alias Mapping (Ch·ªØa ch√°y l·ªói "Unknown Provider")
            if (model === 'imagen-3') model = 'gemini-3-flash';

            outputFunc.innerHTML = '<span class="loading">üì° ƒêang x·ª≠ l√Ω... ' + (type === 'image' ? '(T·∫°o ·∫£nh c√≥ th·ªÉ m·∫•t 10-20s)' : '') + '</span>';

            let body = {};

            // Lu√¥n d√πng c·∫•u tr√∫c Chat (v√¨ Proxy ch·ªâ h·ªó tr·ª£ Chat)
            const messages = [];
            if (selectedImageBase64) {
                messages.push({
                    role: "user",
                    content: [
                        { type: "text", text: prompt },
                        { type: "image_url", image_url: { url: selectedImageBase64 } }
                    ]
                });
            } else {
                messages.push({ role: "user", content: prompt });
            }

            body = {
                model: model,
                messages: messages
            };
            if (useSearch) body.tools = [{ googleSearch: {} }];

            try {
                const response = await fetch(`${host}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error(await response.text());

                // Success
                saveQuotaData(getQuotaData().used + 1);
                const data = await response.json();

                // Handle Response (Text or Image Markdown or Native Images)
                let content = data.choices?.[0]?.message?.content;
                const images = data.choices?.[0]?.message?.images;

                // Fallback: Check Gemini native format (candidates)
                if (!content && !images && data.candidates?.[0]?.content?.parts?.[0]?.text) {
                    content = data.candidates[0].content.parts[0].text;
                }

                // CASE 1: NATIVE IMAGES (Base64 from Proxy)
                if (images && images.length > 0) {
                    let imgHtml = "";
                    images.forEach((img, index) => {
                        if (img.image_url && img.image_url.url) {
                            imgHtml += `
                                <div style="margin-bottom:15px">
                                    <p>‚úÖ <b>·∫¢nh ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng (Native):</b></p>
                                    <img src="${img.image_url.url}" class="generated-img" alt="Generated Image ${index + 1}">
                                    <br><a href="${img.image_url.url}" download="generated_image_${index + 1}.png">‚¨áÔ∏è T·∫£i ·∫£nh n√†y v·ªÅ</a>
                                </div>`;
                        }
                    });

                    // N·∫øu c√≥ c·∫£ text ƒëi k√®m
                    if (content) imgHtml = `<p>${content}</p>` + imgHtml;

                    outputFunc.innerHTML = imgHtml;
                }
                // CASE 2: TEXT CONTENT / TOOL CALLS / MARKDOWN IMAGES
                else if (content) {
                    // Logic tr√≠ch xu·∫•t Prompt t·ª´ JSON l·ªìng nhau (Robust)
                    let promptForImg = "";

                    // Helper: Clean & Parse
                    const cleanJson = (str) => {
                        try {
                            const cleaned = str.replace(/```json/g, "").replace(/```/g, "").trim();
                            return JSON.parse(cleaned);
                        } catch (e) { return null; }
                    };

                    const jsonObj = cleanJson(content);
                    if (jsonObj) {
                        // Case 1: Standard Object
                        if (jsonObj.action_input) {
                            if (typeof jsonObj.action_input === 'string') {
                                // Case 2: Nested JSON String ("action_input": "{\"prompt\":...}")
                                const inner = cleanJson(jsonObj.action_input);
                                if (inner && inner.prompt) promptForImg = inner.prompt;
                            } else if (jsonObj.action_input.prompt) {
                                promptForImg = jsonObj.action_input.prompt;
                            }
                        }
                    }

                    // Fallback: Regex c·ª±c m·∫°nh (B·∫Øt m·ªçi th·ªÉ lo·∫°i prompt="...")
                    if (!promptForImg) {
                        const match = content.match(/["\\]*prompt["\\]*\s*:\s*["\\]*((?:[^"\\]|\\.)*)["\\]*/);
                        if (match && match[1]) {
                            promptForImg = match[1].replace(/\\"/g, '"');
                        }
                    }

                    if (promptForImg) {
                        // Render Pollinations Image
                        const safePrompt = encodeURIComponent(promptForImg);
                        const imgUrl = `https://image.pollinations.ai/prompt/${safePrompt}`;
                        outputFunc.innerHTML = `
                            <p>‚úÖ <b>Model ƒë√£ t·∫°o Prompt v·∫Ω ·∫£nh:</b></p>
                            <p style="font-style:italic; border-left:3px solid #ccc; padding-left:10px; color:#475569">"${promptForImg}"</p>
                            <img src="${imgUrl}" class="generated-img" alt="Generating..." onload="this.style.border='2px solid #4ade80'">
                            <br><a href="${imgUrl}" download="image.png">‚¨áÔ∏è T·∫£i ·∫£nh v·ªÅ</a>
                        `;
                    }
                    // Standard Markdown Image
                    else {
                        const imgMatch = content.match(/\!\[.*?\]\((.*?)\)/);
                        if (imgMatch) {
                            outputFunc.innerHTML = `<p>${content.replace(imgMatch[0], '')}</p><img src="${imgMatch[1]}" class="generated-img"><br><a href="${imgMatch[1]}" download="image.png">‚¨áÔ∏è T·∫£i ·∫£nh v·ªÅ</a>`;
                        } else {
                            outputFunc.innerText = content; // Show Text/JSON if all else fails
                        }
                    }
                } else {
                    // Debug: Show Raw JSON if parsing fails
                    outputFunc.innerHTML = `<p style="color:orange">‚ö†Ô∏è Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c n·ªôi dung (Raw Debug):</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }

            } catch (error) {
                outputFunc.innerHTML = `<span style="color:#ef4444">‚ùå L·ªói: ${error.message}</span>`;
            }
        }
    </script>
</body>

</html>